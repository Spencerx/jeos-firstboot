create_snapshot() {
	local num="$1"
	local desc="$2"
	local important="$3"
	pushd /
	if ! mountpoint -q .snapshots; then
		echo "/.snapshots is not mounted!" >&2
		return 1
	fi
	# we can't use snapper here due to missing dbus daemon in
	# firstboot. So we have to create a snapshot manually.
	#snapper --no-dbus -v create -d "Factory Status" --userdata "important=yes"
	mkdir ".snapshots/$num"
	btrfs subvolume snapshot -r / ".snapshots/$num/snapshot"
	retrofit_snapper_info "$num" "$desc" "$important"
	popd
}

retrofit_snapper_info() {
	local num="$1"
	local desc="$2"
	local important="$3"
	if [ -n "$important" ]; then
		if  [ "$important" = "yes" ]; then
			important="<userdata><key>important</key><value>yes</value></userdata>"
		else
			important=''
		fi
	fi

	now="`date '+%Y-%m-%d %H:%M:%S'`"
	cat > "/.snapshots/$num/info.xml" <<-EOF
	<?xml version="1.0"?>
	<snapshot>
	  <type>single</type>
	  <num>$num</num>
	  <uid>0</uid>
	  <date>$now</date>
	  <description>$desc</description>
	  <cleanup>number</cleanup>
	  $important
	</snapshot>
	EOF
}

kmscon_available() {
    # kmscon itself is installed
    kmscon --help >/dev/null 2>&1 || return 1
    # At least one monospace font is available
    [ -n "$(fc-match "monospace" 2>/dev/null)" ] || return 1

    return 0
}

fbiterm_available() {
    # fbiterm itself is installed
    fbiterm --help >/dev/null 2>&1 || return 1
    # fbiterm comes with its own fallback font

    return 0
}

# Get a property value from org.freedesktop.locale1
queryLocale1() {
	dbus-send --system --print-reply=literal --dest=org.freedesktop.locale1 /org/freedesktop/locale1 org.freedesktop.DBus.Properties.Get "string:org.freedesktop.locale1" "string:$1" | awk '{print $2}'
}

kmscon_localed() {
	# Query whether org.freedesktop.locale1 is available. If it is, try to
	# set XKB_DEFAULT_{MODEL,LAYOUT,VARIANT,OPTIONS} accordingly.
	if queryLocale1 X11Model >/dev/null 2>/dev/null; then
		# Do not overwrite existing values. There is no point in setting only some
		# of them as then they would not match anymore.
		if [ -z "${XKB_DEFAULT_MODEL}" -a -z "${XKB_DEFAULT_LAYOUT}" -a \
		     -z "${XKB_DEFAULT_VARIANT}" -a -z "${XKB_DEFAULT_OPTIONS}" ]; then
			X11MODEL="$(queryLocale1 X11Model)"
			X11LAYOUT="$(queryLocale1 X11Layout)"
			X11VARIANT="$(queryLocale1 X11Variant)"
			X11OPTIONS="$(queryLocale1 X11Options)"
			[ -n "${X11MODEL}" ] && export XKB_DEFAULT_MODEL="${X11MODEL}"
			[ -n "${X11LAYOUT}" ] && export XKB_DEFAULT_LAYOUT="${X11LAYOUT}"
			[ -n "${X11VARIANT}" ] && export XKB_DEFAULT_VARIANT="${X11VARIANT}"
			[ -n "${X11OPTIONS}" ] && export XKB_DEFAULT_OPTIONS="${X11OPTIONS}"
		fi
	fi

	kmscon "$@"
}

# vim: syntax=sh
